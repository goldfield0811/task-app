<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>シンプルタスク管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PWA用 -->
  <meta name="theme-color" content="#2563eb" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png" />
  <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png" />

  <!-- Firebase compat SDK 読み込み -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore-compat.js"></script>

  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #f5f5f7;
      color: #333;
    }
    .app {
      max-width: 960px;
      margin: 0 auto;
      padding: 1rem;
    }
    header {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    header h1 {
      margin: 0;
      font-size: 1.4rem;
    }
    .filters {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      font-size: 0.9rem;
    }
    .filters select {
      padding: 0.2rem 0.4rem;
    }

    .main {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    @media (min-width: 768px) {
      .main {
        flex-direction: row;
        align-items: flex-start;
      }
    }

    .card {
      background: #fff;
      border-radius: 8px;
      padding: 0.8rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    }

    .task-list {
      flex: 1;
      max-height: 70vh;
      overflow-y: auto;
    }

    .task-form {
      flex: 1;
    }

    .task-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    ul#task-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .task-item {
      border-bottom: 1px solid #eee;
      padding: 0.5rem 0;
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
    }
    .task-item:last-child {
      border-bottom: none;
    }

    .task-main-row {
      display: flex;
      justify-content: space-between;
      gap: 0.5rem;
      align-items: center;
    }
    .task-title {
      font-weight: 600;
    }
    .task-meta {
      font-size: 0.78rem;
      color: #777;
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .badge {
      display: inline-block;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      font-size: 0.7rem;
    }
    .badge-priority-low {
      background: #e0f2ff;
      color: #1565c0;
    }
    .badge-priority-medium {
      background: #fff4e0;
      color: #e65100;
    }
    .badge-priority-high {
      background: #ffe0e0;
      color: #c62828;
    }
    .badge-status-todo {
      background: #e0f7fa;
      color: #00838f;
    }
    .badge-status-doing {
      background: #ede7f6;
      color: #4527a0;
    }
    .badge-status-done {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .task-actions {
      display: flex;
      gap: 0.25rem;
      margin-top: 0.2rem;
    }
    button {
      border-radius: 4px;
      border: 1px solid #ccc;
      padding: 0.2rem 0.5rem;
      font-size: 0.8rem;
      cursor: pointer;
      background: #fafafa;
    }
    button:hover {
      background: #f0f0f0;
    }
    .btn-primary {
      border-color: #2563eb;
      background: #2563eb;
      color: #fff;
    }
    .btn-primary:hover {
      background: #1d4ed8;
    }
    .btn-danger {
      border-color: #e53935;
      color: #e53935;
      background: #fff5f5;
    }
    .btn-danger:hover {
      background: #ffebee;
    }
    .btn-secondary {
      border-color: #999;
      color: #555;
    }

    form label {
      display: block;
      font-size: 0.8rem;
      margin-top: 0.4rem;
      margin-bottom: 0.1rem;
    }
    form input[type="text"],
    form input[type="email"],
    form input[type="password"],
    form input[type="date"],
    form select,
    form textarea {
      width: 100%;
      padding: 0.3rem 0.4rem;
      font-size: 0.9rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    form textarea {
      min-height: 80px;
      resize: vertical;
    }
    .form-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.6rem;
      justify-content: flex-end;
    }

    .hint {
      font-size: 0.75rem;
      color: #888;
      margin-top: 0.4rem;
    }

    /* auth section */
    #auth-section {
      margin-bottom: 1rem;
    }
    #auth-section h2 {
      font-size: 1rem;
      margin: 0 0 0.4rem 0;
    }
    #auth-logged-in {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }
    #auth-user-email {
      font-size: 0.85rem;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- ログイン・ユーザー情報 -->
    <section class="card" id="auth-section">
      <h2>ログイン</h2>

      <!-- 未ログイン時 -->
      <div id="auth-logged-out">
        <label for="auth-email">メールアドレス</label>
        <input type="email" id="auth-email" placeholder="example@example.com" />

        <label for="auth-password" style="margin-top:0.4rem;">パスワード</label>
        <input type="password" id="auth-password" placeholder="6文字以上" />

        <div style="margin-top:0.6rem; display:flex; gap:0.5rem; justify-content:flex-end;">
          <button type="button" id="btn-signup">新規登録</button>
          <button type="button" id="btn-login" class="btn-primary">ログイン</button>
        </div>
        <p class="hint" style="margin-top:0.4rem;">
          ※ 初めての方は「新規登録」を押すとユーザー作成とログインを同時に行います。
        </p>
      </div>

      <!-- ログイン済み -->
      <div id="auth-logged-in" style="display:none;">
        <div>
          <span style="font-size:0.8rem; color:#555;">ログイン中：</span>
          <span id="auth-user-email"></span>
        </div>
        <button type="button" id="btn-logout" class="btn-secondary">ログアウト</button>
      </div>
    </section>

    <header>
      <h1>シンプルタスク管理</h1>
      <div class="filters">
        <span>表示フィルタ：</span>
        <select id="filter">
          <option value="all">すべて</option>
          <option value="undone">未完了（未着手＋進行中）</option>
          <option value="done">完了のみ</option>
        </select>
      </div>
    </header>

    <div class="main">
      <!-- タスク一覧 -->
      <section class="card task-list">
        <div class="task-list-header">
          <h2 style="font-size:1rem; margin:0;">タスク一覧</h2>
          <button id="newTaskBtn" class="btn-primary">＋ 新規タスク</button>
        </div>
        <ul id="task-list"></ul>
      </section>

      <!-- タスク登録・編集フォーム -->
      <section class="card task-form">
        <h2 style="font-size:1rem; margin-top:0;">タスク詳細</h2>
        <form id="task-form">
          <input type="hidden" id="taskId" />

          <label for="title">タイトル<span style="color:red;">*</span></label>
          <input type="text" id="title" required placeholder="例）資料作成・メール対応など" />

          <label for="dueDate">期限日</label>
          <input type="date" id="dueDate" />

          <label for="priority">優先度</label>
          <select id="priority">
            <option value="medium">中</option>
            <option value="high">高</option>
            <option value="low">低</option>
          </select>

          <label for="status">状態</label>
          <select id="status">
            <option value="todo">未着手</option>
            <option value="doing">進行中</option>
            <option value="done">完了</option>
          </select>

          <label for="description">メモ</label>
          <textarea id="description" placeholder="補足やメモがあれば入力"></textarea>

          <div class="form-actions">
            <button type="button" id="resetBtn" class="btn-secondary">
              クリア
            </button>
            <button type="submit" class="btn-primary">保存</button>
          </div>

          <p class="hint">
            ログイン中はタスクがクラウドに保存され、PC/SPどこからでも同じ内容を共有できます。
            未ログイン時はこの端末のローカルストレージに保存されます。
          </p>
        </form>
      </section>
    </div>
  </div>

  <script>
    // ▼ Firebase 設定 & 初期化（あなたのプロジェクトの値） ▼
    const firebaseConfig = {
      apiKey: "AIzaSyCVv66kLVOb-jhFI6rZk4Bb6VAuXJdqudM",
      authDomain: "task-app-6c7a9.firebaseapp.com",
      projectId: "task-app-6c7a9",
      storageBucket: "task-app-6c7a9.firebasestorage.app",
      messagingSenderId: "164838034764",
      appId: "1:164838034764:web:cef4f3a2292b00dde993e9",
      measurementId: "G-LJF99YFG4B"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    // ▲ Firebase 初期化ここまで ▲

    document.addEventListener("DOMContentLoaded", () => {
      const STORAGE_KEY = "simpleTaskApp.tasks";

      const taskForm = document.getElementById("task-form");
      const taskIdInput = document.getElementById("taskId");
      const titleInput = document.getElementById("title");
      const dueDateInput = document.getElementById("dueDate");
      const prioritySelect = document.getElementById("priority");
      const statusSelect = document.getElementById("status");
      const descriptionInput = document.getElementById("description");
      const taskListEl = document.getElementById("task-list");
      const filterSelect = document.getElementById("filter");
      const newTaskBtn = document.getElementById("newTaskBtn");
      const resetBtn = document.getElementById("resetBtn");

      // auth UI
      const authLoggedOut = document.getElementById("auth-logged-out");
      const authLoggedIn = document.getElementById("auth-logged-in");
      const authEmailInput = document.getElementById("auth-email");
      const authPassInput = document.getElementById("auth-password");
      const authUserEmailSpan = document.getElementById("auth-user-email");
      const btnSignup = document.getElementById("btn-signup");
      const btnLogin = document.getElementById("btn-login");
      const btnLogout = document.getElementById("btn-logout");

      let tasks = [];
      let currentUser = null;
      let unsubscribeTasks = null;

      // ---- ローカルストレージ関数 ----
      function loadTasks() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          if (!Array.isArray(parsed)) return [];
          return parsed;
        } catch (e) {
          console.warn("タスクの読み込みに失敗しました:", e);
          return [];
        }
      }

      function saveTasks() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
        } catch (e) {
          console.warn("タスクの保存に失敗しました:", e);
        }
      }

      // ---- Firestore 関連 ----
      function subscribeUserTasks(uid) {
        // 既存の購読を解除
        if (unsubscribeTasks) {
          unsubscribeTasks();
          unsubscribeTasks = null;
        }
        unsubscribeTasks = db
          .collection("users")
          .doc(uid)
          .collection("tasks")
          .orderBy("createdAt", "desc")
          .onSnapshot(
            (snapshot) => {
              const list = [];
              snapshot.forEach((doc) => {
                list.push(doc.data());
              });
              tasks = list;
              saveTasks(); // ローカルにもキャッシュ
              renderTasks();
            },
            (error) => {
              console.warn("Firestore購読中にエラー:", error);
            }
          );
      }

      function firestoreSaveTask(uid, task) {
        const ref = db
          .collection("users")
          .doc(uid)
          .collection("tasks")
          .doc(task.id);
        return ref.set(task);
      }

      function firestoreDeleteTask(uid, taskId) {
        const ref = db
          .collection("users")
          .doc(uid)
          .collection("tasks")
          .doc(taskId);
        return ref.delete();
      }

      // ---- Auth 状態の監視 ----
      auth.onAuthStateChanged((user) => {
        if (user) {
          currentUser = user;
          authLoggedOut.style.display = "none";
          authLoggedIn.style.display = "flex";
          authUserEmailSpan.textContent = user.email || "";

          // Firestore のタスクを購読
          subscribeUserTasks(user.uid);
        } else {
          currentUser = null;
          authLoggedOut.style.display = "block";
          authLoggedIn.style.display = "none";
          authUserEmailSpan.textContent = "";

          // Firestore購読解除
          if (unsubscribeTasks) {
            unsubscribeTasks();
            unsubscribeTasks = null;
          }

          // ローカルストレージから読み込み
          tasks = loadTasks();
          renderTasks();
        }
      });

      // 初期表示（ログイン前でもローカルデータがあれば表示）
      tasks = loadTasks();
      renderTasks();

      // ---- Auth ボタンイベント ----
      btnSignup.addEventListener("click", async () => {
        const email = authEmailInput.value.trim();
        const password = authPassInput.value;
        if (!email || !password) {
          alert("メールアドレスとパスワードを入力してください。");
          return;
        }
        try {
          await auth.createUserWithEmailAndPassword(email, password);
          alert("ユーザー登録＆ログインしました。");
        } catch (e) {
          console.error(e);
          alert("ユーザー登録に失敗しました: " + e.message);
        }
      });

      btnLogin.addEventListener("click", async () => {
        const email = authEmailInput.value.trim();
        const password = authPassInput.value;
        if (!email || !password) {
          alert("メールアドレスとパスワードを入力してください。");
          return;
        }
        try {
          await auth.signInWithEmailAndPassword(email, password);
          // onAuthStateChanged 側で画面更新される
        } catch (e) {
          console.error(e);
          alert("ログインに失敗しました: " + e.message);
        }
      });

      btnLogout.addEventListener("click", async () => {
        try {
          await auth.signOut();
        } catch (e) {
          console.error(e);
          alert("ログアウトに失敗しました: " + e.message);
        }
      });

      // ---- タスク関連イベント ----

      // 保存（新規 or 更新）
      taskForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const title = titleInput.value.trim();
        if (!title) {
          alert("タイトルは必須です。");
          return;
        }

        const now = new Date().toISOString();
        const existingId = taskIdInput.value;
        let targetTask = null;

        if (existingId) {
          // 更新
          tasks = tasks.map((t) => {
            if (t.id === existingId) {
              const updated = {
                ...t,
                title,
                dueDate: dueDateInput.value || null,
                priority: prioritySelect.value,
                status: statusSelect.value,
                description: descriptionInput.value,
                updatedAt: now
              };
              targetTask = updated;
              return updated;
            }
            return t;
          });
        } else {
          // 新規
          const newTask = {
            id: "task-" + Date.now().toString(36),
            title,
            dueDate: dueDateInput.value || null,
            priority: prioritySelect.value,
            status: statusSelect.value,
            description: descriptionInput.value,
            createdAt: now,
            updatedAt: now
          };
          tasks.unshift(newTask); // 上に追加
          targetTask = newTask;
        }

        saveTasks();
        renderTasks();
        clearForm();

        if (currentUser && targetTask) {
          firestoreSaveTask(currentUser.uid, targetTask).catch((e) => {
            console.warn("Firestore保存エラー:", e);
          });
        }
      });

      // 新規タスクボタン（フォームのクリア）
      newTaskBtn.addEventListener("click", () => {
        clearForm();
        titleInput.focus();
      });

      // クリアボタン
      resetBtn.addEventListener("click", () => {
        clearForm();
      });

      // フィルタ変更
      filterSelect.addEventListener("change", () => {
        renderTasks();
      });

      // タスク一覧内のクリック（イベント委譲）
      taskListEl.addEventListener("click", (e) => {
        const li = e.target.closest("li.task-item");
        if (!li) return;
        const id = li.dataset.id;
        if (!id) return;

        if (e.target.matches(".edit-btn")) {
          const task = tasks.find((t) => t.id === id);
          if (task) {
            loadTaskToForm(task);
          }
        } else if (e.target.matches(".delete-btn")) {
          if (confirm("このタスクを削除しますか？")) {
            tasks = tasks.filter((t) => t.id !== id);
            saveTasks();
            renderTasks();
            if (taskIdInput.value === id) {
              clearForm();
            }
            if (currentUser) {
              firestoreDeleteTask(currentUser.uid, id).catch((err) => {
                console.warn("Firestore削除エラー:", err);
              });
            }
          }
        } else if (e.target.matches(".toggle-done-btn")) {
          let targetTask = null;
          tasks = tasks.map((t) => {
            if (t.id === id) {
              const updated = {
                ...t,
                status: t.status === "done" ? "todo" : "done",
                updatedAt: new Date().toISOString()
              };
              targetTask = updated;
              return updated;
            }
            return t;
          });
          saveTasks();
          renderTasks();
          if (currentUser && targetTask) {
            firestoreSaveTask(currentUser.uid, targetTask).catch((e) => {
              console.warn("Firestore保存エラー:", e);
            });
          }
        }
      });

      // ---- 共通関数 ----
      function renderTasks() {
        taskListEl.innerHTML = "";

        const filter = filterSelect.value;
        let filtered = tasks.slice();

        if (filter === "undone") {
          filtered = filtered.filter(
            (t) => t.status === "todo" || t.status === "doing"
          );
        } else if (filter === "done") {
          filtered = filtered.filter((t) => t.status === "done");
        }

        if (filtered.length === 0) {
          const empty = document.createElement("li");
          empty.textContent = "タスクはありません。";
          empty.style.fontSize = "0.85rem";
          empty.style.color = "#888";
          taskListEl.appendChild(empty);
          return;
        }

        for (const task of filtered) {
          const li = document.createElement("li");
          li.className = "task-item";
          li.dataset.id = task.id;

          const mainRow = document.createElement("div");
          mainRow.className = "task-main-row";

          const titleSpan = document.createElement("span");
          titleSpan.className = "task-title";
          if (task.status === "done") {
            titleSpan.style.textDecoration = "line-through";
            titleSpan.style.color = "#777";
          }
          titleSpan.textContent = task.title;

          const toggleBtn = document.createElement("button");
          toggleBtn.type = "button";
          toggleBtn.className = "toggle-done-btn";
          toggleBtn.textContent =
            task.status === "done" ? "未完了に戻す" : "完了にする";

          mainRow.appendChild(titleSpan);
          mainRow.appendChild(toggleBtn);

          const meta = document.createElement("div");
          meta.className = "task-meta";

          if (task.dueDate) {
            const due = document.createElement("span");
            due.textContent = "期限: " + task.dueDate;
            meta.appendChild(due);
          }

          const priorityBadge = document.createElement("span");
          priorityBadge.className =
            "badge " + getPriorityBadgeClass(task.priority);
          priorityBadge.textContent =
            "優先度: " + getPriorityLabel(task.priority);
          meta.appendChild(priorityBadge);

          const statusBadge = document.createElement("span");
          statusBadge.className =
            "badge " + getStatusBadgeClass(task.status);
          statusBadge.textContent = "状態: " + getStatusLabel(task.status);
          meta.appendChild(statusBadge);

          const actions = document.createElement("div");
          actions.className = "task-actions";

          const editBtn = document.createElement("button");
          editBtn.type = "button";
          editBtn.className = "edit-btn";
          editBtn.textContent = "編集";

          const deleteBtn = document.createElement("button");
          deleteBtn.type = "button";
          deleteBtn.className = "delete-btn btn-danger";
          deleteBtn.textContent = "削除";

          actions.appendChild(editBtn);
          actions.appendChild(deleteBtn);

          li.appendChild(mainRow);
          li.appendChild(meta);
          li.appendChild(actions);

          taskListEl.appendChild(li);
        }
      }

      function clearForm() {
        taskIdInput.value = "";
        titleInput.value = "";
        dueDateInput.value = "";
        prioritySelect.value = "medium";
        statusSelect.value = "todo";
        descriptionInput.value = "";
      }

      function loadTaskToForm(task) {
        taskIdInput.value = task.id;
        titleInput.value = task.title || "";
        dueDateInput.value = task.dueDate || "";
        prioritySelect.value = task.priority || "medium";
        statusSelect.value = task.status || "todo";
        descriptionInput.value = task.description || "";
      }

      function getPriorityLabel(priority) {
        switch (priority) {
          case "high":
            return "高";
          case "low":
            return "低";
          default:
            return "中";
        }
      }

      function getStatusLabel(status) {
        switch (status) {
          case "todo":
            return "未着手";
          case "doing":
            return "進行中";
          case "done":
            return "完了";
          default:
            return status;
        }
      }

      function getPriorityBadgeClass(priority) {
        switch (priority) {
          case "high":
            return "badge-priority-high";
          case "low":
            return "badge-priority-low";
          default:
            return "badge-priority-medium";
        }
      }

      function getStatusBadgeClass(status) {
        switch (status) {
          case "todo":
            return "badge-status-todo";
          case "doing":
            return "badge-status-doing";
          case "done":
            return "badge-status-done";
          default:
            return "";
        }
      }
    });

    // ▼ Service Worker 登録（PWA用）
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker
          .register("service-worker.js")
          .catch((err) => {
            console.log("Service Worker registration failed:", err);
          });
      });
    }
    // ▲ ここまで
  </script>
</body>
</html>
